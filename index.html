<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Syntax Card Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/ohm-js@16.4.0/dist/ohm.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root {
            --bg-dark: #1a202c;
            --bg-medium: #2d3748;
            --bg-light: #4a5568;
            --text-light: #e2e8f0;
            --text-dark: #a0aec0;
            --accent: #4fd1c5;
            --accent-dark: #38b2ac;
            --success: #68d391;
            --error: #fc8181;
            --warning: #f6e05e;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        #mode-modal-overlay {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-medium);
            color: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 450px;
        }
        
        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 2rem;
            font-size: 1.8rem;
        }
        
        .modal-content h3 {
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .modal-content button {
            background-color: var(--accent);
            color: var(--bg-dark);
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease, opacity 0.3s ease;
            font-weight: 600;
            width: 100%;
        }

        .modal-content button:hover:not(:disabled) {
            background-color: var(--accent-dark);
        }

        .modal-content button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--bg-light);
        }
        
        .modal-content button.secondary {
             background-color: var(--bg-light);
             color: var(--text-light);
        }
        .modal-content button.secondary:hover {
             background-color: #5a6b87;
        }

        .modal-content input {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 1rem;
            border-radius: 5px;
            border: 2px solid var(--bg-light);
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-size: 1rem;
            text-align: center;
        }
        .modal-content input::placeholder {
            color: var(--text-dark);
        }
        .modal-content .button-group {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        #multiplayer-feedback {
            min-height: 24px;
            margin-top: 1rem;
            color: var(--error);
            font-weight: 600;
        }
        
        .segmented-control {
            display: flex;
            width: 100%;
            border: 1px solid var(--bg-light);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        .segmented-control button {
            flex: 1;
            padding: 12px;
            background-color: transparent;
            border: none;
            color: var(--text-dark);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            margin: 0;
            border-radius: 0;
            width: 50%;
        }
        .segmented-control button.active {
            background-color: var(--accent);
            color: var(--bg-dark);
        }
        .segmented-control button:not(.active):hover {
            background-color: var(--bg-light);
            color: var(--text-light);
        }

        #group-code-display {
            margin-top: 1.5rem;
            font-size: 1.1rem;
        }
        #group-code-display strong {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: var(--bg-dark);
            border-radius: 5px;
            color: var(--accent);
            letter-spacing: 2px;
            margin-left: 0.5rem;
        }
        
        #waiting-room-player-list {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--bg-dark);
            border-radius: 5px;
            padding: 1rem;
        }
        #waiting-room-player-list li {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            border-bottom: 1px solid var(--bg-light);
        }
        #waiting-room-player-list li:last-child {
            border-bottom: none;
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--bg-medium);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--bg-light);
            display: none; 
        }

        header {
            text-align: center;
            margin-bottom: 1rem;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
            margin: 0;
        }

        header p {
            color: var(--text-dark);
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        #challenge-display {
            background-color: rgba(0,0,0,0.2);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--accent);
        }

        #challenge-display h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        #progress-tracker {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-dark);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        #progress-bar-container {
            width: 100%;
            background-color: var(--bg-dark);
            border-radius: 99px;
            height: 1rem;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-dark), var(--accent));
            border-radius: 99px;
            transition: width 0.3s ease-in-out;
        }

        #timer {
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--bg-light);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-weight: 700;
        }

        #sentence-tray {
            background-color: var(--bg-dark);
            border: 2px dashed var(--bg-light);
            border-radius: 0.5rem;
            padding: 1rem;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            margin: 1.5rem 0;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #sentence-tray.drag-over {
            border-color: var(--accent);
            background-color: #3c4a61;
        }

        #word-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            padding: 1rem;
            background-color: var(--bg-dark);
            border-radius: 0.5rem;
            min-height: 80px;
        }

        .word-tile {
            background-color: var(--bg-light);
            color: var(--text-light);
            padding: 0.75rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: grab;
            transition: background-color 0.3s, transform 0.2s, opacity 0.2s;
            user-select: none;
        }

        .word-tile:hover {
            background-color: #5a6b87;
        }
        
        .word-tile.dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }

        #feedback-area {
            text-align: center;
            margin-top: 1.5rem;
            min-height: 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feedback-correct {
            color: var(--success);
        }

        .feedback-incorrect {
            color: var(--error);
        }

        #action-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--accent);
            color: var(--bg-dark);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--accent-dark);
        }
        .btn-primary:disabled {
             background-color: #555;
             cursor: not-allowed;
        }

        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-light);
        }
        .btn-secondary:hover {
            background-color: #5a6b87;
        }

        #multiplayer-scoreboard {
            display: none;
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--bg-dark);
            border-radius: 0.5rem;
        }
        #multiplayer-scoreboard h3 {
            margin-top: 0;
            text-align: center;
            color: var(--accent);
        }
        #player-scores {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #player-scores li {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--bg-light);
        }
        #player-scores li:last-child {
            border-bottom: none;
        }
        #player-scores .player-name {
            font-weight: 600;
        }
         #player-scores .player-score {
            font-weight: 700;
            color: var(--success);
        }

    </style>
</head>
<body>
    <!-- MODALS -->
    <div id="mode-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Welcome to The Syntax Card Game!</h2>
            <h3>Choose Your Mode</h3>
            <div class="button-group">
                <button id="single-player-mode-btn">Single Player</button>
                <button id="multiplayer-mode-btn">Multiplayer</button>
            </div>
        </div>
    </div>
    
    <div id="player-setup-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Player Setup</h2>
            <h3>Select Your Proficiency</h3>
            <div class="button-group">
                <button class="proficiency-btn" data-level="beginner">Beginner</button>
                <button class="proficiency-btn" data-level="advanced">Advanced</button>
                <button class="proficiency-btn" data-level="professional">Professional</button>
            </div>
            <div id="resume-game-container" style="margin-top: 20px; display: none;">
                <p>Or</p>
                <button id="resume-game-btn" class="secondary">Resume Previous Game</button>
            </div>
        </div>
    </div>

    <div id="multiplayer-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Multiplayer Setup</h2>
            <div class="segmented-control">
                <button id="multiplayer-create-tab" class="active">Create Group</button>
                <button id="multiplayer-join-tab">Join Group</button>
            </div>
            <input type="text" id="nickname-input" placeholder="Enter your nickname (max 15 chars)" maxlength="15">
            <input type="text" id="group-code-input" placeholder="Enter 3-digit group code" style="display: none;" maxlength="3">
            <div id="multiplayer-feedback">Connecting to server...</div>
            <div class="button-group">
                <button id="join-group-btn" class="secondary" disabled style="display: none;">Join Group</button>
                <button id="create-group-btn" disabled>Create Group</button>
            </div>
        </div>
    </div>
    
    <div id="waiting-room-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Waiting Room</h2>
            <p>Share this code with your friends!</p>
            <div id="group-code-display">Group Code: <strong>...</strong></div>
            <h3>Players Joined:</h3>
            <ul id="waiting-room-player-list">
            </ul>
            <button id="start-game-btn">Start Game</button>
        </div>
    </div>

    <div id="game-over-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2 id="game-over-title">Level Complete!</h2>
            <p id="game-over-message">You've finished all questions for this proficiency level.</p>
            <h3>Final Score: <span id="final-score">0</span></h3>
            <div class="button-group">
                <button id="play-again-btn">Play Again</button>
            </div>
        </div>
    </div>

    <!-- GAME CONTAINER -->
    <div id="game-container">
        <header>
            <h1 id="game-title">The Syntax Card Game</h1>
            <p id="game-subtitle">Arrange the words to match the target sentence structure.</p>
            <div id="timer">Time: 50</div>
        </header>

        <main>
            <div id="challenge-display">
                <h2>TARGET: <span id="target-grammar"></span></h2>
            </div>
            <div id="progress-tracker">
                <div id="level-indicator">Proficiency: Beginner</div>
                <div id="question-indicator">Question: 1/8</div>
            </div>
            <div id="progress-bar-container">
                <div id="progress-bar"></div>
            </div>

            <div id="sentence-tray" class="droppable"></div>
            <div id="word-pool" class="droppable"></div>

            <div id="feedback-area"></div>

            <div id="action-buttons">
                <button id="reset-btn" class="btn btn-secondary">Reset</button>
                <button id="check-btn" class="btn btn-primary">Check Answer</button>
            </div>

            <div id="multiplayer-scoreboard">
                <h3>Scoreboard</h3>
                <ul id="player-scores">
                </ul>
            </div>
        </main>
    </div>

<script type="ohm-js" id="grammar">
  SyntaxCardGame {
    // Top-level rules correspond to level targets
    // Noun, Pronoun, Verb, Det(erminer), Adj(ective), Adv(erb), 
    // Prep(osition), Conj(unction), Punc(tuation), Comma

    // Beginner
    Det_N_V_Punc = Det Noun Verb Punc
    Pronoun_V_Punc = Pronoun Verb Punc
    Pronoun_V_Det_N_Punc = Pronoun Verb Det Noun Punc
    N_V_Adj_Punc = Noun Verb Adj Punc
    Pronoun_V_Adv_Punc = Pronoun Verb Adv Punc
    Det_Adj_N_V_Punc = Det Adj Noun Verb Punc
    Pronoun_V_Det_Adj_N_Punc = Pronoun Verb Det Adj Noun Punc
    Pronoun_V_N_Punc = Pronoun Verb Noun Punc

    // Advanced
    Pronoun_V_Ving_Det_Adj_N_Punc = Pronoun Verb Ving Det Adj Noun Punc
    Pronoun_V_Prep_Det_N_Punc = Pronoun Verb Prep Det Noun Punc
    Poss_N_V_Det_Adj_N_Punc = Poss Noun Verb Det Adj Noun Punc
    Det_Adj_N_V_Adv_Punc = Det Adj Noun Verb Adv Punc
    Pronoun_V_Adj_Conj_Pronoun_V_Adj_Punc = Pronoun Verb Adj Conj Pronoun Verb Adj Punc

    // Professional
    Det_Adj_Adj_N_V_Prep_Det_Adj_N_Punc = Det Adj Adj Noun Verb Prep Det Adj Noun Punc
    Pronoun_V_Adv_Prep_Poss_N_Punc = Pronoun Verb Noun Adv Prep Poss Noun Punc
    Conj_Clause_Clause_Punc = Prep Det Noun Comma Pronoun Verb Prep Verb Prep Det Noun Punc
    Sentence_With_Comma = Det_Noun_Clause Comma Conj Noun_Clause Punc
    Det_Noun_Clause = Det Noun Verb Adj
    Noun_Clause = Det Noun Verb Adv Adj
    
    // Parts of Speech Definitions (terminals)
    Noun = "Noun"
    Pronoun = "Pronoun"
    Verb = "Verb"
    Ving = "Ving" // Gerund/Participle
    Det = "Det"
    Adj = "Adj"
    Adv = "Adv"
    Prep = "Prep"
    Conj = "Conj"
    Poss = "Poss"
    Punc = "Punc"
    Comma = "Comma"
  }
</script>
    
<script type="module">
    // --- STATE MANAGEMENT ---
    const state = {
        gameMode: 'single', // 'single' or 'multi'
        proficiency: 'beginner',
        currentQuestionIndex: 0,
        totalQuestions: 0,
        score: 0,
        timer: 50,
        timerInterval: null,
        currentWords: [],
        playerData: { id: null, nickname: '', score: 0 },
        groupCode: null,
        players: [],
        socket: null
    };

    // --- DOM ELEMENTS ---
    const elements = {
        gameContainer: document.getElementById('game-container'),
        targetGrammar: document.getElementById('target-grammar'),
        levelIndicator: document.getElementById('level-indicator'),
        questionIndicator: document.getElementById('question-indicator'),
        progressBar: document.getElementById('progress-bar'),
        sentenceTray: document.getElementById('sentence-tray'),
        wordPool: document.getElementById('word-pool'),
        feedbackArea: document.getElementById('feedback-area'),
        checkBtn: document.getElementById('check-btn'),
        resetBtn: document.getElementById('reset-btn'),
        timerDisplay: document.getElementById('timer'),
        modeModal: document.getElementById('mode-modal-overlay'),
        singlePlayerBtn: document.getElementById('single-player-mode-btn'),
        multiplayerBtn: document.getElementById('multiplayer-mode-btn'),
        playerSetupModal: document.getElementById('player-setup-modal-overlay'),
        proficiencyBtns: document.querySelectorAll('.proficiency-btn'),
        resumeGameContainer: document.getElementById('resume-game-container'),
        resumeGameBtn: document.getElementById('resume-game-btn'),
        multiplayerModal: document.getElementById('multiplayer-modal-overlay'),
        nicknameInput: document.getElementById('nickname-input'),
        groupCodeInput: document.getElementById('group-code-input'),
        joinGroupBtn: document.getElementById('join-group-btn'),
        createGroupBtn: document.getElementById('create-group-btn'),
        multiplayerFeedback: document.getElementById('multiplayer-feedback'),
        waitingRoomModal: document.getElementById('waiting-room-modal-overlay'),
        groupCodeDisplay: document.querySelector('#group-code-display strong'),
        waitingPlayerList: document.getElementById('waiting-room-player-list'),
        startGameBtn: document.getElementById('start-game-btn'),
        multiplayerScoreboard: document.getElementById('multiplayer-scoreboard'),
        playerScoresList: document.getElementById('player-scores'),
        multiplayerCreateTab: document.getElementById('multiplayer-create-tab'),
        multiplayerJoinTab: document.getElementById('multiplayer-join-tab'),
        gameOverModal: document.getElementById('game-over-modal-overlay'),
        gameOverTitle: document.getElementById('game-over-title'),
        gameOverMessage: document.getElementById('game-over-message'),
        finalScore: document.getElementById('final-score'),
        playAgainBtn: document.getElementById('play-again-btn'),
    };

    // --- OHM.JS GRAMMAR ---
    const grammar = ohm.grammar(document.getElementById('grammar').textContent);

    // --- GAME LEVELS ---
    const levels = {
        beginner: [
            { rule: "Det_N_V_Punc", words: [{word: "The", type: "Det"}, {word: "dog", type: "Noun"}, {word: "runs", type: "Verb"}, {word: ".", type: "Punc"}] },
            { rule: "Pronoun_V_Punc", words: [{word: "She", type: "Pronoun"}, {word: "sleeps", type: "Verb"}, {word: ".", type: "Punc"}] },
            { rule: "Pronoun_V_Det_N_Punc", words: [{word: "He", type: "Pronoun"}, {word: "eats", type: "Verb"}, {word: "an", type: "Det"}, {word: "apple", type: "Noun"}, {word: ".", type: "Punc"}] },
            { rule: "N_V_Adj_Punc", words: [{word: "You", type: "Noun"}, {word: "are", type: "Verb"}, {word: "smart", type: "Adj"}, {word: ".", type: "Punc"}]},
            { rule: "Pronoun_V_Adv_Punc", words: [{word: "Birds", type: "Pronoun"}, {word: "fly", type: "Verb"}, {word: "high", type: "Adv"}, {word: ".", type: "Punc"}]},
            { rule: "Det_Adj_N_V_Punc", words: [{word: "A", type: "Det"}, {word: "big", type: "Adj"}, {word: "cat", type: "Noun"}, {word: "jumps", type: "Verb"}, {word: ".", type: "Punc"}] },
            { rule: "Pronoun_V_Det_Adj_N_Punc", words: [{word: "I", type: "Pronoun"}, {word: "see", type: "Verb"}, {word: "a", type: "Det"}, {word: "big", type: "Adj"}, {word: "ball", type: "Noun"}, {word: ".", type: "Punc"}]},
            { rule: "Pronoun_V_N_Punc", words: [{word: "We", type: "Pronoun"}, {word: "play", type: "Verb"}, {word: "games", type: "Noun"}, {word: ".", type: "Punc"}]},
        ],
        advanced: [
            { rule: "Pronoun_V_Ving_Det_Adj_N_Punc", words: [{word: "She", type: "Pronoun"}, {word: "is", type: "Verb"}, {word: "reading", type: "Ving"}, {word: "a", type: "Det"}, {word: "good", type: "Adj"}, {word: "book", type: "Noun"}, {word: ".", type: "Punc"}] },
            { rule: "Pronoun_V_Prep_Det_N_Punc", words: [{word: "He", type: "Pronoun"}, {word: "walked", type: "Verb"}, {word: "to", type: "Prep"}, {word: "the", type: "Det"}, {word: "store", type: "Noun"}, {word: ".", type: "Punc"}] },
            { rule: "Poss_N_V_Det_Adj_N_Punc", words: [{word: "My", type: "Poss"}, {word: "friend", type: "Noun"}, {word: "has", type: "Verb"}, {word: "a", type: "Det"}, {word: "new", type: "Adj"}, {word: "car", type: "Noun"}, {word: ".", type: "Punc"}] },
            { rule: "Det_Adj_N_V_Adv_Punc", words: [{word: "The", type: "Det"}, {word: "little", type: "Adj"}, {word: "dog", type: "Noun"}, {word: "barks", type: "Verb"}, {word: "loudly", type: "Adv"}, {word: ".", type: "Punc"}] },
            { rule: "Pronoun_V_Det_Adj_N_Punc", words: [{word: "She", type: "Pronoun"}, {word: "wrote", type: "Verb"}, {word: "a", type: "Det"}, {word: "long", type: "Adj"}, {word: "letter", type: "Noun"}, {word: ".", type: "Punc"}] },
            { rule: "Pronoun_V_Adj_Conj_Pronoun_V_Adj_Punc", words: [{word:"I", type: "Pronoun"}, {word:"was", type: "Verb"}, {word:"tired", type: "Adj"}, {word:"but", type: "Conj"}, {word:"I", type: "Pronoun"}, {word:"was", type: "Verb"}, {word:"happy", type: "Adj"}, {word:".", type: "Punc"}]}
        ],
        professional: [
            { rule: "Det_Adj_Adj_N_V_Prep_Det_Adj_N_Punc", words: [{word: "The", type: "Det"}, {word: "quick", type: "Adj"}, {word: "brown", type: "Adj"}, {word: "fox", type: "Noun"}, {word: "jumps", type: "Verb"}, {word: "over", type: "Prep"}, {word: "the", type: "Det"}, {word: "lazy", type: "Adj"}, {word: "dog", type: "Noun"}, {word: ".", type: "Punc"}] },
            { rule: "Pronoun_V_Adv_Prep_Poss_N_Punc", words: [{word:"She", type: "Pronoun"}, {word:"organized", type: "Verb"}, {word:"files", type: "Noun"}, {word:"meticulously", type: "Adv"}, {word:"on", type: "Prep"}, {word:"her", type: "Poss"}, {word:"computer", type: "Noun"}, {word:".", type: "Punc"}]},
            { rule: "Conj_Clause_Clause_Punc", words: [{word:"Despite", type: "Prep"}, {word:"the", type: "Det"}, {word:"rain", type: "Noun"}, {word:",", type: "Comma"}, {word:"we", type: "Pronoun"}, {word:"decided", type: "Verb"}, {word:"to", type: "Prep"}, {word:"go", type: "Verb"}, {word:"for", type: "Prep"}, {word:"a", type: "Det"}, {word:"walk", type: "Noun"}, {word:".", type: "Punc"}]},
            { rule: "Sentence_With_Comma", words: [{word: "The", type: "Det"}, {word: "concert", type: "Noun"}, {word: "was", type: "Verb"}, {word: "fantastic", type: "Adj"}, {word: ",", type: "Comma"}, {word: "but", type: "Conj"}, {word: "the", type: "Det"}, {word: "tickets", type: "Noun"}, {word: "were", type: "Verb"}, {word: "quite", type: "Adv"}, {word: "expensive", type: "Adj"}, {word: ".", type: "Punc"}]}
        ]
    };

    // --- SOCKET.IO SETUP ---
    const SERVER_URL = 'https://cognitive-psy-assessment.onrender.com';

    function connectToServer() {
        if (state.socket && state.socket.connected) return;
        state.socket = io(SERVER_URL, { reconnectionAttempts: 5, timeout: 10000 });

        elements.multiplayerFeedback.textContent = 'Connecting to server...';
        elements.joinGroupBtn.disabled = true;
        elements.createGroupBtn.disabled = true;

        state.socket.on('connect', () => {
            console.log('Connected to server with ID:', state.socket.id);
            state.playerData.id = state.socket.id;
            elements.multiplayerFeedback.textContent = '';
            elements.joinGroupBtn.disabled = false;
            elements.createGroupBtn.disabled = false;
        });

        state.socket.on('connect_error', () => elements.multiplayerFeedback.textContent = `Connection failed. Please check your network.`);
        state.socket.on('disconnect', () => elements.multiplayerFeedback.textContent = 'Connection lost.');
        state.socket.on('groupCreated', ({ groupCode, players }) => {
            state.groupCode = groupCode;
            state.players = players;
            elements.multiplayerModal.style.display = 'none';
            elements.waitingRoomModal.style.display = 'flex';
            elements.groupCodeDisplay.textContent = groupCode;
            updateWaitingRoom(players);
        });
        state.socket.on('joinSuccess', ({ groupCode }) => {
            state.groupCode = groupCode;
            elements.multiplayerModal.style.display = 'none';
            elements.waitingRoomModal.style.display = 'flex';
            elements.groupCodeDisplay.textContent = groupCode;
        });
        state.socket.on('joinError', (message) => elements.multiplayerFeedback.textContent = message);
        state.socket.on('updatePlayers', (players) => {
            state.players = players;
            updateWaitingRoom(players);
            if (state.gameMode === 'multi') updateMultiplayerScoreboard(players);
        });
        state.socket.on('gameStarted', () => {
            elements.waitingRoomModal.style.display = 'none';
            startGame();
        });
    }

    // --- UI & EVENT LISTENERS ---
    elements.singlePlayerBtn.addEventListener('click', () => {
        state.gameMode = 'single';
        elements.modeModal.style.display = 'none';
        elements.playerSetupModal.style.display = 'flex';
        if (localStorage.getItem('syntaxGameState')) {
            elements.resumeGameContainer.style.display = 'block';
        }
    });
    elements.multiplayerBtn.addEventListener('click', () => {
        state.gameMode = 'multi';
        elements.modeModal.style.display = 'none';
        elements.multiplayerModal.style.display = 'flex';
        connectToServer();
    });
    elements.proficiencyBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            state.proficiency = btn.dataset.level;
            elements.playerSetupModal.style.display = 'none';
            startGame();
        });
    });
    elements.resumeGameBtn.addEventListener('click', () => {
        loadState();
        elements.playerSetupModal.style.display = 'none';
        startGame(true); // Pass flag to indicate resuming
    });
    elements.playAgainBtn.addEventListener('click', () => window.location.reload());
    elements.multiplayerCreateTab.addEventListener('click', () => {
        elements.multiplayerCreateTab.classList.add('active');
        elements.multiplayerJoinTab.classList.remove('active');
        elements.groupCodeInput.style.display = 'none';
        elements.createGroupBtn.style.display = 'block';
        elements.joinGroupBtn.style.display = 'none';
    });
    elements.multiplayerJoinTab.addEventListener('click', () => {
        elements.multiplayerJoinTab.classList.add('active');
        elements.multiplayerCreateTab.classList.remove('active');
        elements.groupCodeInput.style.display = 'block';
        elements.createGroupBtn.style.display = 'none';
        elements.joinGroupBtn.style.display = 'block';
    });
    elements.createGroupBtn.addEventListener('click', () => {
        const nickname = elements.nicknameInput.value;
        if (!nickname.trim()) return elements.multiplayerFeedback.textContent = 'Please enter a nickname.';
        state.playerData.nickname = nickname.slice(0, 15);
        elements.multiplayerFeedback.textContent = '';
        state.socket.emit('createGroup', state.playerData);
    });
    elements.joinGroupBtn.addEventListener('click', () => {
        const nickname = elements.nicknameInput.value;
        const groupCode = elements.groupCodeInput.value;
        if (!nickname.trim() || !groupCode.trim()) return elements.multiplayerFeedback.textContent = 'Nickname and group code are required.';
        state.playerData.nickname = nickname.slice(0, 15);
        elements.multiplayerFeedback.textContent = '';
        state.socket.emit('joinGroup', { playerData: state.playerData, groupCode });
    });
    elements.startGameBtn.addEventListener('click', () => {
        if(state.socket && state.groupCode) state.socket.emit('startGameRequest', state.groupCode);
    });
    elements.checkBtn.addEventListener('click', checkSentence);
    elements.resetBtn.addEventListener('click', resetWordPositions);

    // --- DRAG AND DROP LOGIC ---
    function initializeDragAndDrop() {
        document.querySelectorAll('.word-tile').forEach(draggable => {
            draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
            draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));
        });
        document.querySelectorAll('.droppable').forEach(container => {
            container.addEventListener('dragover', e => {
                e.preventDefault();
                container.classList.add('drag-over');
                const afterElement = getDragAfterElement(container, e.clientX, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (draggable) {
                   if (afterElement == null) container.appendChild(draggable);
                   else container.insertBefore(draggable, afterElement);
                }
            });
            container.addEventListener('dragleave', () => container.classList.remove('drag-over'));
            container.addEventListener('drop', () => container.classList.remove('drag-over'));
        });
    }
    
    function getDragAfterElement(container, x, y) {
        const draggableElements = [...container.querySelectorAll('.word-tile:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offsetX = x - box.left - box.width / 2;
            const offsetY = y - box.top - box.height / 2;
            const distance = Math.sqrt(offsetX*offsetX + offsetY*offsetY);
            if (distance < closest.distance) return { distance: distance, element: child };
            else return closest;
        }, { distance: Number.POSITIVE_INFINITY }).element;
    }

    // --- GAME LOGIC FUNCTIONS ---
    function startGame(isResuming = false) {
        elements.gameContainer.style.display = 'block';
        if (state.gameMode === 'multi') {
            elements.multiplayerScoreboard.style.display = 'block';
            updateMultiplayerScoreboard(state.players);
        }
        state.totalQuestions = levels[state.proficiency].length;
        if (!isResuming) {
            state.currentQuestionIndex = 0;
            state.score = 0;
        }
        loadQuestion();
    }
    
    function loadQuestion() {
        if (state.currentQuestionIndex >= state.totalQuestions) {
            endGame();
            return;
        }
        const levelData = levels[state.proficiency][state.currentQuestionIndex];
        state.currentWords = [...levelData.words].sort(() => Math.random() - 0.5);
        elements.targetGrammar.textContent = levelData.rule.replace(/_/g, ' - ');
        elements.checkBtn.disabled = false;
        renderWords();
        updateUI();
        startTimer();
    }

    function checkSentence() {
        clearInterval(state.timerInterval);
        elements.checkBtn.disabled = true;
        const sentenceTiles = Array.from(elements.sentenceTray.querySelectorAll('.word-tile'));
        const wordPoolHasTiles = elements.wordPool.children.length > 0;

        if (sentenceTiles.length === 0) {
            elements.checkBtn.disabled = false;
            return;
        }

        const level = levels[state.proficiency][state.currentQuestionIndex];
        const typeSequence = sentenceTiles.map(tile => tile.dataset.type).join(' ');
        const match = grammar.match(typeSequence, level.rule);

        if (match.succeeded() && !wordPoolHasTiles) {
            elements.feedbackArea.textContent = "Correct!";
            elements.feedbackArea.className = 'feedback-correct';
            state.score += state.timer;
            if(state.gameMode === 'multi' && state.socket) {
                state.playerData.score = state.score;
                state.socket.emit('updateScore', { id: state.playerData.id, score: state.playerData.score, groupCode: state.groupCode });
            }
            setTimeout(nextQuestion, 1500);
        } else {
            let feedback = "That's not quite right. Try again!";
            if (wordPoolHasTiles) {
                feedback = `Hint: You haven't used all the words yet.`;
            } else if (match.failed()) {
                const friendlyRule = level.rule.replace(/_/g, ' - ');
                feedback = `Hint: The word order is incorrect. Remember the target: ${friendlyRule}.`;
            }
            elements.feedbackArea.textContent = feedback;
            elements.feedbackArea.className = 'feedback-incorrect';
            setTimeout(() => { elements.checkBtn.disabled = false; }, 1000);
        }
        updateUI();
    }
    
    function nextQuestion() {
        state.currentQuestionIndex++;
        if (state.gameMode === 'single') saveState();
        loadQuestion();
    }
    
    function endGame() {
        clearInterval(state.timerInterval);
        elements.finalScore.textContent = state.score;
        elements.gameOverModal.style.display = 'flex';
        if (state.gameMode === 'single') localStorage.removeItem('syntaxGameState');
    }

    function startTimer() {
        state.timer = 50;
        elements.timerDisplay.textContent = `Time: ${state.timer}`;
        clearInterval(state.timerInterval);
        state.timerInterval = setInterval(() => {
            state.timer--;
            elements.timerDisplay.textContent = `Time: ${state.timer}`;
            if (state.timer <= 0) {
                clearInterval(state.timerInterval);
                elements.feedbackArea.textContent = "Time's up! No points awarded.";
                elements.feedbackArea.className = 'feedback-incorrect';
                elements.checkBtn.disabled = true;
                setTimeout(nextQuestion, 2000);
            }
        }, 1000);
    }
    
    function resetWordPositions() {
        const sentenceTiles = elements.sentenceTray.querySelectorAll('.word-tile');
        sentenceTiles.forEach(tile => elements.wordPool.appendChild(tile));
    }

    // --- PROGRESS SAVING ---
    function saveState() {
        localStorage.setItem('syntaxGameState', JSON.stringify({
            proficiency: state.proficiency,
            currentQuestionIndex: state.currentQuestionIndex,
            score: state.score,
        }));
    }

    function loadState() {
        const savedState = JSON.parse(localStorage.getItem('syntaxGameState'));
        if (savedState) {
            state.proficiency = savedState.proficiency;
            state.currentQuestionIndex = savedState.currentQuestionIndex;
            state.score = savedState.score;
        }
    }

    // --- UI UPDATE FUNCTIONS ---
    function renderWords() {
        elements.wordPool.innerHTML = '';
        elements.sentenceTray.innerHTML = '';
        elements.feedbackArea.innerHTML = '';
        state.currentWords.forEach(wordData => {
            const tile = document.createElement('div');
            tile.className = 'word-tile';
            tile.textContent = wordData.word;
            tile.dataset.type = wordData.type;
            tile.draggable = true;
            elements.wordPool.appendChild(tile);
        });
        initializeDragAndDrop();
    }

    function updateUI() {
        const capitalizedProficiency = state.proficiency.charAt(0).toUpperCase() + state.proficiency.slice(1);
        elements.levelIndicator.textContent = `Proficiency: ${capitalizedProficiency}`;
        elements.questionIndicator.textContent = `Question: ${state.currentQuestionIndex + 1}/${state.totalQuestions}`;
        const progress = (state.currentQuestionIndex / state.totalQuestions) * 100;
        elements.progressBar.style.width = `${progress}%`;
    }

    function updateWaitingRoom(players) {
        elements.waitingPlayerList.innerHTML = '';
        players.forEach(player => {
            const li = document.createElement('li');
            li.textContent = player.nickname;
            elements.waitingPlayerList.appendChild(li);
        });
    }

    function updateMultiplayerScoreboard(players) {
        elements.playerScoresList.innerHTML = '';
        const sortedPlayers = [...players].sort((a,b) => b.score - a.score);
        sortedPlayers.forEach(player => {
            const li = document.createElement('li');
            const isCurrentUser = player.id === state.playerData.id;
            li.innerHTML = `
                <span class="player-name">${player.nickname}${isCurrentUser ? ' (You)' : ''}</span>
                <span class="player-score">${player.score}</span>
            `;
            elements.playerScoresList.appendChild(li);
        });
    }

</script>
</body>
</html>