<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Syntax Card Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/ohm-js@16.4.0/dist/ohm.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root {
            --bg-dark: #1a202c;
            --bg-medium: #2d3748;
            --bg-light: #4a5568;
            --text-light: #e2e8f0;
            --text-dark: #a0aec0;
            --accent: #4fd1c5;
            --accent-dark: #38b2ac;
            --success: #68d391;
            --error: #fc8181;
            --warning: #f6e05e;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        #mode-modal-overlay {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-medium);
            color: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 450px;
        }
        
        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 2rem;
            font-size: 1.8rem;
        }
        
        .modal-content h3 {
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .modal-content button {
            background-color: var(--accent);
            color: var(--bg-dark);
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease, opacity 0.3s ease;
            font-weight: 600;
            width: 100%;
        }

        .modal-content button:hover:not(:disabled) {
            background-color: var(--accent-dark);
        }

        .modal-content button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--bg-light);
        }
        
        .modal-content button.secondary {
             background-color: var(--bg-light);
             color: var(--text-light);
        }
        .modal-content button.secondary:hover {
             background-color: #5a6b87;
        }

        .modal-content input {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 1rem;
            border-radius: 5px;
            border: 2px solid var(--bg-light);
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-size: 1rem;
            text-align: center;
        }
        .modal-content input::placeholder {
            color: var(--text-dark);
        }
        .modal-content .button-group {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        #multiplayer-feedback {
            min-height: 24px;
            margin-top: 1rem;
            color: var(--error);
            font-weight: 600;
        }
        
        .segmented-control {
            display: flex;
            width: 100%;
            border: 1px solid var(--bg-light);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        .segmented-control button {
            flex: 1;
            padding: 12px;
            background-color: transparent;
            border: none;
            color: var(--text-dark);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            margin: 0;
            border-radius: 0;
            width: 50%;
        }
        .segmented-control button.active {
            background-color: var(--accent);
            color: var(--bg-dark);
        }
        .segmented-control button:not(.active):hover {
            background-color: var(--bg-light);
            color: var(--text-light);
        }

        #group-code-display {
            margin-top: 1.5rem;
            font-size: 1.1rem;
        }
        #group-code-display strong {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: var(--bg-dark);
            border-radius: 5px;
            color: var(--accent);
            letter-spacing: 2px;
            margin-left: 0.5rem;
        }
        
        #waiting-room-player-list {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--bg-dark);
            border-radius: 5px;
            padding: 1rem;
        }
        #waiting-room-player-list li {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            border-bottom: 1px solid var(--bg-light);
        }
        #waiting-room-player-list li:last-child {
            border-bottom: none;
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--bg-medium);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--bg-light);
            display: none; 
        }

        header {
            text-align: center;
            margin-bottom: 1rem;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
            margin: 0;
        }

        header p {
            color: var(--text-dark);
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        #challenge-display {
            background-color: rgba(0,0,0,0.2);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--accent);
        }

        #challenge-display h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .progress-tracker {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-dark);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .progress-bar-container {
            width: 100%;
            background-color: var(--bg-dark);
            border-radius: 99px;
            height: 1rem;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-dark), var(--accent));
            border-radius: 99px;
            transition: width 0.3s ease-in-out;
        }

        #timer {
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--bg-light);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-weight: 700;
        }

        #sentence-tray {
            background-color: var(--bg-dark);
            border: 2px dashed var(--bg-light);
            border-radius: 0.5rem;
            padding: 1rem;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            margin: 1.5rem 0;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #sentence-tray.drag-over {
            border-color: var(--accent);
            background-color: #3c4a61;
        }

        #word-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            padding: 1rem;
            background-color: var(--bg-dark);
            border-radius: 0.5rem;
            min-height: 80px;
        }

        .word-tile {
            background-color: var(--bg-light);
            color: var(--text-light);
            padding: 0.75rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s, opacity 0.2s;
            user-select: none;
        }

        #word-pool .word-tile {
            cursor: pointer;
        }
        
        #sentence-tray .word-tile {
            cursor: grab;
        }

        #word-pool .word-tile:hover {
            background-color: #5a6b87;
            transform: translateY(-2px);
        }
        
        #sentence-tray .word-tile:hover {
            background-color: #5a6b87;
        }
        
        .word-tile.dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }

        .placeholder {
            background-color: var(--bg-dark);
            border: 2px dashed var(--accent);
            border-radius: 0.375rem;
        }

        #feedback-area {
            text-align: center;
            margin-top: 1.5rem;
            min-height: 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feedback-correct {
            color: var(--success);
        }

        .feedback-incorrect {
            color: var(--error);
        }

        #action-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--accent);
            color: var(--bg-dark);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--accent-dark);
        }
        .btn-primary:disabled {
             background-color: #555;
             cursor: not-allowed;
        }

        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-light);
        }
        .btn-secondary:hover {
            background-color: #5a6b87;
        }

        #multiplayer-scoreboard {
            display: none;
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--bg-dark);
            border-radius: 0.5rem;
        }
        #multiplayer-scoreboard h3 {
            margin-top: 0;
            text-align: center;
            color: var(--accent);
        }
        #player-scores {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #player-scores li {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--bg-light);
        }
        #player-scores li:last-child {
            border-bottom: none;
        }
        #player-scores .player-name {
            font-weight: 600;
        }
         #player-scores .player-score {
            font-weight: 700;
            color: var(--success);
        }

        /* --- QUIZ STYLES --- */
        #quiz-question-area {
            background-color: var(--bg-dark);
            padding: 1.5rem 2rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--accent);
            text-align: center;
        }
        #quiz-question-text {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
            line-height: 1.6;
        }
        #quiz-options-area {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin: 2rem 0;
        }
        .quiz-option-btn {
            background-color: var(--bg-light);
            color: var(--text-light);
            border: 2px solid transparent;
            padding: 1rem;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: left;
        }
        .quiz-option-btn:hover:not(:disabled) {
            background-color: #5a6b87;
            border-color: var(--accent);
        }
        .quiz-option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .quiz-option-btn.correct {
            background-color: var(--success);
            color: var(--bg-dark);
            border-color: var(--success);
        }
        .quiz-option-btn.incorrect {
            background-color: var(--error);
            color: var(--bg-dark);
            border-color: var(--error);
        }
        #quiz-feedback-area {
            min-height: 24px;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
        }
        #quiz-action-buttons {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .modal-content {
                padding: 25px;
                max-width: 95%;
            }
            
            .modal-content h2 {
                font-size: 1.5rem;
                margin-bottom: 1.5rem;
            }

            #game-container {
                padding: 1rem;
            }

            header {
                margin-bottom: 1rem;
                position: static;
            }

            h1 {
                font-size: 1.8rem;
            }

            header p {
                font-size: 1rem;
            }

            #challenge-display {
                padding: 0.75rem 1rem;
                margin-bottom: 1rem;
            }

            #challenge-display h2 {
                font-size: 1rem;
            }

            #timer {
                position: static;
                margin-top: 0.5rem;
                text-align: center;
                width: 100%;
                background-color: transparent;
                padding: 0.5rem 0;
                font-size: 1.1rem;
            }

            #sentence-tray, #word-pool {
                min-height: 70px;
                padding: 0.75rem;
                gap: 0.5rem;
            }

            .word-tile {
                padding: 0.7rem 1.2rem;
                font-size: 1rem;
            }

            #action-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }
            .btn {
                width: 100%;
            }

            #quiz-options-area {
                gap: 0.75rem;
                margin: 1.5rem 0;
            }
            #quiz-question-area {
                padding: 1rem 1.25rem;
            }
             #quiz-question-text {
                font-size: 1.1rem;
            }
            .quiz-option-btn {
                padding: 0.8rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- MODALS -->
    <div id="mode-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Welcome to The Syntax Card Game!</h2>
            <h3>Choose Your Mode</h3>
            <div class="button-group">
                <button id="single-player-mode-btn">Single Player</button>
                <button id="multiplayer-mode-btn">Multiplayer</button>
                <button id="quiz-mode-btn">Syntax Quiz</button>
            </div>
        </div>
    </div>
    
    <div id="player-setup-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Player Setup</h2>
            <h3>Select Your Proficiency</h3>
            <div class="button-group">
                <button class="proficiency-btn" data-level="beginner">Beginner</button>
                <button class="proficiency-btn" data-level="advanced">Advanced</button>
                <button class="proficiency-btn" data-level="professional">Professional</button>
            </div>
            <div id="resume-game-container" style="margin-top: 20px; display: none;">
                <p>Or</p>
                <button id="resume-game-btn" class="secondary">Resume Previous Game</button>
            </div>
            <div class="button-group" style="margin-top: 1rem;">
                <button id="back-from-setup-btn" class="secondary">Back</button>
            </div>
        </div>
    </div>

    <div id="quiz-setup-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Syntax Quiz Setup</h2>
            <h3>Select Your Difficulty</h3>
            <div class="button-group">
                <button class="quiz-proficiency-btn" data-level="beginner">Beginner</button>
                <button class="quiz-proficiency-btn" data-level="advanced">Advanced</button>
                <button class="quiz-proficiency-btn" data-level="professional">Professional</button>
            </div>
            <div class="button-group" style="margin-top: 1rem;">
                <button id="back-from-quiz-setup-btn" class="secondary">Back</button>
            </div>
        </div>
    </div>

    <div id="multiplayer-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Multiplayer Setup</h2>
            <div class="segmented-control">
                <button id="multiplayer-create-tab" class="active">Create Group</button>
                <button id="multiplayer-join-tab">Join Group</button>
            </div>
            <input type="text" id="nickname-input" placeholder="Enter your nickname (max 15 chars)" maxlength="15">
            <input type="text" id="group-code-input" placeholder="Enter 3-digit group code" style="display: none;" maxlength="3">
            <div id="multiplayer-feedback">Connecting to server...</div>
            <div class="button-group">
                <button id="join-group-btn" class="secondary" disabled style="display: none;">Join Group</button>
                <button id="create-group-btn" disabled>Create Group</button>
                <button id="back-from-multiplayer-btn" class="secondary">Back</button>
            </div>
        </div>
    </div>
    
    <div id="multiplayer-proficiency-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Choose Game Difficulty</h2>
            <h3 style="color: var(--text-dark); font-size: 1rem; margin-bottom: 2rem;">The host selects the proficiency for all players.</h3>
            <div class="button-group">
                <button class="multiplayer-proficiency-btn" data-level="beginner">Beginner</button>
                <button class="multiplayer-proficiency-btn" data-level="advanced">Advanced</button>
                <button class="multiplayer-proficiency-btn" data-level="professional">Professional</button>
            </div>
            <div class="button-group" style="margin-top: 1rem;">
                <button id="back-from-multiplayer-proficiency-btn" class="secondary">Back</button>
            </div>
        </div>
    </div>

    <div id="waiting-room-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Waiting Room</h2>
            <p>Share this code with your friends!</p>
            <div id="group-code-display">Group Code: <strong>...</strong></div>
            <h3>Players Joined:</h3>
            <ul id="waiting-room-player-list">
            </ul>
            <div class="button-group">
                <button id="start-game-btn" style="display: none;">Start Game</button>
                <button id="back-from-waiting-btn" class="secondary">Back</button>
            </div>
        </div>
    </div>

    <div id="game-over-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2 id="game-over-title">Level Complete!</h2>
            <p id="game-over-message">You've finished all questions for this proficiency level.</p>
            <h3>Final Score: <span id="final-score">0</span></h3>
            <div class="button-group">
                <button id="play-again-btn">Play Again</button>
            </div>
        </div>
    </div>

    <!-- GAME CONTAINER -->
    <div id="game-container">
        <div id="game-view">
            <header>
                <h1 id="game-title">The Syntax Card Game</h1>
                <p id="game-subtitle">Arrange the words to match the target sentence structure.</p>
                <div id="timer">Time: 50</div>
            </header>

            <main>
                <div id="challenge-display">
                    <h2>TARGET: <span id="target-grammar"></span></h2>
                </div>
                <div id="progress-tracker" class="progress-tracker">
                    <div id="level-indicator">Proficiency: Beginner</div>
                    <div id="question-indicator">Question: 1/10</div>
                </div>
                <div id="progress-bar-container" class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>

                <div id="sentence-tray" class="droppable"></div>
                <div id="word-pool" class="droppable"></div>

                <div id="feedback-area"></div>

                <div id="action-buttons">
                    <button id="reset-btn" class="btn btn-secondary">Reset</button>
                    <button id="check-btn" class="btn btn-primary">Check Answer</button>
                </div>

                <div id="multiplayer-scoreboard">
                    <h3>Scoreboard</h3>
                    <ul id="player-scores">
                    </ul>
                </div>
            </main>
        </div>
        <div id="quiz-view" style="display: none;">
             <header>
                <h1>Syntax Quiz</h1>
                <p>Test your grammar knowledge.</p>
            </header>
            <main>
                <div id="quiz-progress-tracker" class="progress-tracker">
                    <div id="quiz-level-indicator">Difficulty: Beginner</div>
                    <div id="quiz-question-indicator">Question: 1/10</div>
                </div>
                <div id="quiz-progress-bar-container" class="progress-bar-container">
                    <div id="quiz-progress-bar" class="progress-bar"></div>
                </div>
                <div id="quiz-question-area">
                    <h2 id="quiz-question-text"></h2>
                </div>
                <div id="quiz-options-area"></div>
                <div id="quiz-feedback-area"></div>
                <div id="quiz-action-buttons">
                    <button id="next-question-btn" class="btn btn-primary" style="display: none;">Next Question</button>
                </div>
            </main>
        </div>
    </div>

<script type="ohm-js" id="grammar">
  SyntaxCardGame {
    // Top-level rules correspond to level targets
    // Noun, Pronoun, Verb, Determiner, Adjective, Adverb, 
    // Preposition, Conjunction, Punctuation, Comma

    // Beginner
    Determiner_Noun_Verb_Punctuation = Determiner Noun Verb Punctuation
    Pronoun_Verb_Punctuation = Pronoun Verb Punctuation
    Pronoun_Verb_Determiner_Noun_Punctuation = Pronoun Verb Determiner Noun Punctuation
    Noun_Verb_Adjective_Punctuation = Noun Verb Adjective Punctuation
    Pronoun_Verb_Adverb_Punctuation = Pronoun Verb Adverb Punctuation
    Determiner_Adjective_Noun_Verb_Punctuation = Determiner Adjective Noun Verb Punctuation
    Pronoun_Verb_Determiner_Adjective_Noun_Punctuation = Pronoun Verb Determiner Adjective Noun Punctuation
    Pronoun_Verb_Noun_Punctuation = Pronoun Verb Noun Punctuation

    // Advanced
    Pronoun_Verb_Ving_Determiner_Adjective_Noun_Punctuation = Pronoun Verb Ving Determiner Adjective Noun Punctuation
    Pronoun_Verb_Preposition_Determiner_Noun_Punctuation = Pronoun Verb Preposition Determiner Noun Punctuation
    Possessive_Noun_Verb_Determiner_Adjective_Noun_Punctuation = Possessive Noun Verb Determiner Adjective Noun Punctuation
    Determiner_Adjective_Noun_Verb_Adverb_Punctuation = Determiner Adjective Noun Verb Adverb Punctuation
    Pronoun_Verb_Adjective_Conjunction_Pronoun_Verb_Adjective_Punctuation = Pronoun Verb Adjective Conjunction Pronoun Verb Adjective Punctuation

    // Professional
    Determiner_Adjective_Adjective_Noun_Verb_Preposition_Determiner_Adjective_Noun_Punctuation = Determiner Adjective Adjective Noun Verb Preposition Determiner Adjective Noun Punctuation
    Pronoun_Verb_Noun_Adverb_Preposition_Possessive_Noun_Punctuation = Pronoun Verb Noun Adverb Preposition Possessive Noun Punctuation
    Conjunction_Clause_Clause_Punctuation = Preposition Determiner Noun Comma Pronoun Verb Preposition Verb Preposition Determiner Noun Punctuation
    Sentence_With_Comma = Determiner_Noun_Clause Comma Conjunction Noun_Clause Punctuation
    Determiner_Noun_Clause = Determiner Noun Verb Adjective
    Noun_Clause = Determiner Noun Verb Adverb Adjective

    // Expanded Rules
    Pronoun_Verb_Adjective_Punctuation = Pronoun Verb Adjective Punctuation
    Noun_Verb_Punctuation = Noun Verb Punctuation
    Determiner_Noun_Verb_Determiner_Noun_Punctuation = Determiner Noun Verb Determiner Noun Punctuation
    Pronoun_Verb_Adjective_Noun_Punctuation = Pronoun Verb Adjective Noun Punctuation
    Pronoun_Verb_Determiner_Noun_Preposition_Determiner_Noun_Punctuation = Pronoun Verb Determiner Noun Preposition Determiner Noun Punctuation
    Pronoun_Verb_Adjective_Comma_Conjunction_Pronoun_Verb_Adjective_Punctuation = Pronoun Verb Adjective Comma Conjunction Pronoun Verb Adjective Punctuation
    Pronoun_Verb_Conjunction_Verb_Punctuation = Pronoun Verb Conjunction Verb Punctuation
    Pronoun_Verb_Verb_Conjunction_Pronoun_Verb_Ving_Punctuation = Pronoun Verb Verb Conjunction Pronoun Verb Ving Punctuation
    Determiner_Noun_Verb_Adverb_Punctuation = Determiner Noun Verb Adverb Punctuation
    Pronoun_Verb_Pronoun_Determiner_Noun_Punctuation = Pronoun Verb Pronoun Determiner Noun Punctuation
    Determiner_Noun_Verb_Preposition_Determiner_Noun_Punctuation = Determiner Noun Verb Preposition Determiner Noun Punctuation
    Pronoun_Verb_Ving_Preposition_Determiner_Noun_Punctuation = Pronoun Verb Ving Preposition Determiner Noun Punctuation
    Pronoun_Verb_Preposition_Verb_Punctuation = Pronoun Verb Preposition Verb Punctuation
    Pronoun_Verb_Conjunction_Determiner_Noun_Verb_Adjective_Punctuation = Pronoun Verb Conjunction Determiner Noun Verb Adjective Punctuation
    Determiner_Noun_Verb_Determiner_Noun_Preposition_Determiner_Noun_Punctuation = Determiner Noun Verb Determiner Noun Preposition Determiner Noun Punctuation
    Pronoun_Verb_Determiner_Adjective_Noun_Preposition_Determiner_Noun_Punctuation = Pronoun Verb Determiner Adjective Noun Preposition Determiner Noun Punctuation
    
    // Parts of Speech Definitions (terminals)
    Noun = "Noun"
    Pronoun = "Pronoun"
    Verb = "Verb"
    Ving = "Ving" // Gerund/Participle
    Determiner = "Determiner"
    Adjective = "Adjective"
    Adverb = "Adverb"
    Preposition = "Preposition"
    Conjunction = "Conjunction"
    Possessive = "Possessive"
    Punctuation = "Punctuation"
    Comma = "Comma"
  }
</script>
    
<script type="module">
    // --- STATE MANAGEMENT ---
    const state = {
        gameMode: null, // 'single', 'multi', 'quiz'
        // Card Game State
        proficiency: 'beginner',
        currentQuestionIndex: 0,
        totalQuestions: 0,
        score: 0,
        timer: 50,
        timerInterval: null,
        currentWords: [],
        // Multiplayer State
        playerData: { id: null, nickname: '', score: 0 },
        groupCode: null,
        players: [],
        socket: null,
        // Quiz State
        quizProficiency: 'beginner',
        currentQuizQuestionIndex: 0,
        quizScore: 0,
        quizQuestions: [],
    };

    // --- DOM ELEMENTS ---
    const elements = {
        gameContainer: document.getElementById('game-container'),
        // Views
        gameView: document.getElementById('game-view'),
        quizView: document.getElementById('quiz-view'),
        // Modals
        modeModal: document.getElementById('mode-modal-overlay'),
        playerSetupModal: document.getElementById('player-setup-modal-overlay'),
        quizSetupModal: document.getElementById('quiz-setup-modal-overlay'),
        multiplayerModal: document.getElementById('multiplayer-modal-overlay'),
        multiplayerProficiencyModal: document.getElementById('multiplayer-proficiency-modal-overlay'),
        waitingRoomModal: document.getElementById('waiting-room-modal-overlay'),
        gameOverModal: document.getElementById('game-over-modal-overlay'),
        // Mode Buttons
        singlePlayerBtn: document.getElementById('single-player-mode-btn'),
        multiplayerBtn: document.getElementById('multiplayer-mode-btn'),
        quizBtn: document.getElementById('quiz-mode-btn'),
        // Card Game Elements
        targetGrammar: document.getElementById('target-grammar'),
        levelIndicator: document.getElementById('level-indicator'),
        questionIndicator: document.getElementById('question-indicator'),
        progressBar: document.getElementById('progress-bar'),
        sentenceTray: document.getElementById('sentence-tray'),
        wordPool: document.getElementById('word-pool'),
        feedbackArea: document.getElementById('feedback-area'),
        checkBtn: document.getElementById('check-btn'),
        resetBtn: document.getElementById('reset-btn'),
        timerDisplay: document.getElementById('timer'),
        // Single Player Setup
        proficiencyBtns: document.querySelectorAll('.proficiency-btn'),
        resumeGameContainer: document.getElementById('resume-game-container'),
        resumeGameBtn: document.getElementById('resume-game-btn'),
        backFromSetupBtn: document.getElementById('back-from-setup-btn'),
        // Quiz Setup
        quizProficiencyBtns: document.querySelectorAll('.quiz-proficiency-btn'),
        backFromQuizSetupBtn: document.getElementById('back-from-quiz-setup-btn'),
        // Multiplayer Elements
        nicknameInput: document.getElementById('nickname-input'),
        groupCodeInput: document.getElementById('group-code-input'),
        joinGroupBtn: document.getElementById('join-group-btn'),
        createGroupBtn: document.getElementById('create-group-btn'),
        multiplayerFeedback: document.getElementById('multiplayer-feedback'),
        groupCodeDisplay: document.querySelector('#group-code-display strong'),
        waitingPlayerList: document.getElementById('waiting-room-player-list'),
        startGameBtn: document.getElementById('start-game-btn'),
        multiplayerScoreboard: document.getElementById('multiplayer-scoreboard'),
        playerScoresList: document.getElementById('player-scores'),
        multiplayerCreateTab: document.getElementById('multiplayer-create-tab'),
        multiplayerJoinTab: document.getElementById('multiplayer-join-tab'),
        backFromMultiplayerBtn: document.getElementById('back-from-multiplayer-btn'),
        multiplayerProficiencyBtns: document.querySelectorAll('.multiplayer-proficiency-btn'),
        backFromMultiplayerProficiencyBtn: document.getElementById('back-from-multiplayer-proficiency-btn'),
        backFromWaitingBtn: document.getElementById('back-from-waiting-btn'),
        // Game Over Modal
        gameOverTitle: document.getElementById('game-over-title'),
        gameOverMessage: document.getElementById('game-over-message'),
        finalScore: document.getElementById('final-score'),
        playAgainBtn: document.getElementById('play-again-btn'),
        // Quiz Elements
        quizLevelIndicator: document.getElementById('quiz-level-indicator'),
        quizQuestionIndicator: document.getElementById('quiz-question-indicator'),
        quizProgressBar: document.getElementById('quiz-progress-bar'),
        quizQuestionText: document.getElementById('quiz-question-text'),
        quizOptionsArea: document.getElementById('quiz-options-area'),
        quizFeedbackArea: document.getElementById('quiz-feedback-area'),
        nextQuestionBtn: document.getElementById('next-question-btn'),
    };

    // --- OHM.JS GRAMMAR ---
    const grammar = ohm.grammar(document.getElementById('grammar').textContent);

    // --- GAME & QUIZ DATA ---
    const levels = {
        beginner: [
            { 
                rule: "Determiner_Noun_Verb_Punctuation",
                displayRule: 'Subject - Verb - Punctuation', 
                words: [{word: "The", type: "Determiner"}, {word: "dog", type: "Noun"}, {word: "runs", type: "Verb"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Pronoun_Verb_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Punctuation', 
                words: [{word: "She", type: "Pronoun"}, {word: "ate", type: "Verb"}, {word: "an", type: "Determiner"}, {word: "apple", type: "Noun"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Determiner_Noun_Verb_Punctuation",
                displayRule: 'Subject - Verb - Punctuation', 
                words: [{word: "A", type: "Determiner"}, {word: "cat", type: "Noun"}, {word: "slept", type: "Verb"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Pronoun_Verb_Adjective_Punctuation",
                displayRule: 'Subject - Verb - Adjective - Punctuation', 
                words: [{word: "They", type: "Pronoun"}, {word: "are", type: "Verb"}, {word: "happy", type: "Adjective"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Pronoun_Verb_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Punctuation', 
                words: [{word: "He", type: "Pronoun"}, {word: "kicked", type: "Verb"}, {word: "the", type: "Determiner"}, {word: "ball", type: "Noun"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Noun_Verb_Punctuation",
                displayRule: 'Subject - Verb - Punctuation', 
                words: [{word: "Birds", type: "Noun"}, {word: "fly", type: "Verb"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Determiner_Noun_Verb_Punctuation",
                displayRule: 'Subject - Verb - Punctuation', 
                words: [{word: "The", type: "Determiner"}, {word: "wind", type: "Noun"}, {word: "howled", type: "Verb"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Determiner_Noun_Verb_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Punctuation', 
                words: [{word: "The", type: "Determiner"}, {word: "girl", type: "Noun"}, {word: "wrote", type: "Verb"}, {word: "a", type: "Determiner"}, {word: "letter", type: "Noun"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Pronoun_Verb_Adjective_Punctuation",
                displayRule: 'Subject - Verb - Adjective - Punctuation', 
                words: [{word: "I", type: "Pronoun"}, {word: "am", type: "Verb"}, {word: "tired", type: "Adjective"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Pronoun_Verb_Adjective_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Punctuation', 
                words: [{word: "We", type: "Pronoun"}, {word: "play", type: "Verb"}, {word: "video", type: "Adjective"}, {word: "games", type: "Noun"}, {word: ".", type: "Punctuation"}] 
            },
        ],
        advanced: [
            { 
                rule: "Pronoun_Verb_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Preposition - Determiner - Noun - Punctuation', 
                words: [{word: "He", type: "Pronoun"}, {word: "walked", type: "Verb"}, {word: "to", type: "Preposition"}, {word: "the", type: "Determiner"}, {word: "store", type: "Noun"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Pronoun_Verb_Determiner_Noun_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Prepositional Phrase - Punctuation', 
                words: [{word: "She", type: "Pronoun"}, {word: "put", type: "Verb"}, {word: "the", type: "Determiner"}, {word: "keys", type: "Noun"}, {word: "on", type: "Preposition"}, {word: "the", type: "Determiner"}, {word: "table", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Pronoun_Verb_Adjective_Comma_Conjunction_Pronoun_Verb_Adjective_Punctuation",
                displayRule: 'Subject - Verb - Adjective - Conjunction - Subject - Verb - Adjective - Punctuation', 
                words: [{word:"I", type: "Pronoun"}, {word:"was", type: "Verb"}, {word:"tired", type: "Adjective"}, {word:",", type: "Comma"}, {word:"but", type: "Conjunction"}, {word:"I", type: "Pronoun"}, {word:"was", type: "Verb"}, {word:"happy", type: "Adjective"}, {word:".", type: "Punctuation"}]
            },
            { 
                rule: "Pronoun_Verb_Conjunction_Verb_Punctuation",
                displayRule: 'Subject - Verb - Conjunction - Verb - Punctuation', 
                words: [{word: "He", type: "Pronoun"}, {word: "sang", type: "Verb"}, {word: "and", type: "Conjunction"}, {word: "danced", type: "Verb"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Pronoun_Verb_Determiner_Noun_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Prepositional Phrase - Punctuation', 
                words: [{word: "He", type: "Pronoun"}, {word: "read", type: "Verb"}, {word: "the", type: "Determiner"}, {word: "book", type: "Noun"}, {word: "in", type: "Preposition"}, {word: "the", type: "Determiner"}, {word: "park", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Pronoun_Verb_Verb_Conjunction_Pronoun_Verb_Ving_Punctuation",
                displayRule: 'Subject - Verb - Subordinate Clause - Punctuation', 
                words: [{word: "We", type: "Pronoun"}, {word: "will", type: "Verb"}, {word: "go", type: "Verb"}, {word: "if", type: "Conjunction"}, {word: "it", type: "Pronoun"}, {word: "stops", type: "Verb"}, {word: "raining", type: "Ving"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Determiner_Noun_Verb_Adverb_Punctuation",
                displayRule: 'Subject - Verb - Adverb - Punctuation', 
                words: [{word: "The", type: "Determiner"}, {word: "dog", type: "Noun"}, {word: "barked", type: "Verb"}, {word: "loudly", type: "Adverb"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Pronoun_Verb_Pronoun_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Punctuation', 
                words: [{word: "He", type: "Pronoun"}, {word: "gave", type: "Verb"}, {word: "her", type: "Pronoun"}, {word: "a", type: "Determiner"}, {word: "gift", type: "Noun"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Determiner_Noun_Verb_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Punctuation', 
                words: [{word: "The", type: "Determiner"}, {word: "student", type: "Noun"}, {word: "passed", type: "Verb"}, {word: "the", type: "Determiner"}, {word: "test", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Determiner_Noun_Verb_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Prepositional Phrase - Punctuation', 
                words: [{word: "The", type: "Determiner"}, {word: "artist", type: "Noun"}, {word: "painted", type: "Verb"}, {word: "with", type: "Preposition"}, {word: "a", type: "Determiner"}, {word: "brush", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
        ],
        professional: [
            { 
                rule: "Pronoun_Verb_Ving_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Gerund - Prepositional Phrase - Punctuation', 
                words: [{word: "She", type: "Pronoun"}, {word: "enjoys", type: "Verb"}, {word: "running", type: "Ving"}, {word: "in", type: "Preposition"}, {word: "the", type: "Determiner"}, {word: "morning", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Pronoun_Verb_Preposition_Verb_Punctuation",
                displayRule: 'Subject - Verb - Infinitive - Punctuation', 
                words: [{word: "They", type: "Pronoun"}, {word: "want", type: "Verb"}, {word: "to", type: "Preposition"}, {word: "eat", type: "Verb"}, {word: ".", type: "Punctuation"}] 
            },
            { 
                rule: "Pronoun_Verb_Conjunction_Determiner_Noun_Verb_Adjective_Punctuation",
                displayRule: 'Subject - Verb - Subordinate Clause - Punctuation', 
                words: [{word: "He", type: "Pronoun"}, {word: "knew", type: "Verb"}, {word: "that", type: "Conjunction"}, {word: "the", type: "Determiner"}, {word: "project", type: "Noun"}, {word: "was", type: "Verb"}, {word: "late", type: "Adjective"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Determiner_Noun_Verb_Determiner_Noun_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Prepositional Phrase - Punctuation', 
                words: [{word: "The", type: "Determiner"}, {word: "man", type: "Noun"}, {word: "saw", type: "Verb"}, {word: "the", type: "Determiner"}, {word: "boy", type: "Noun"}, {word: "with", type: "Preposition"}, {word: "the", type: "Determiner"}, {word: "telescope", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Determiner_Noun_Verb_Determiner_Noun_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Prepositional Phrase - Punctuation', 
                words: [{word: "The", type: "Determiner"}, {word: "chef", type: "Noun"}, {word: "baked", type: "Verb"}, {word: "a", type: "Determiner"}, {word: "cake", type: "Noun"}, {word: "in", type: "Preposition"}, {word: "the", type: "Determiner"}, {word: "oven", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Pronoun_Verb_Determiner_Noun_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Prepositional Phrase - Punctuation', 
                words: [{word: "She", type: "Pronoun"}, {word: "read", type: "Verb"}, {word: "a", type: "Determiner"}, {word: "book", type: "Noun"}, {word: "on", type: "Preposition"}, {word: "the", type: "Determiner"}, {word: "train", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Pronoun_Verb_Determiner_Noun_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Prepositional Phrase - Punctuation', 
                words: [{word: "He", type: "Pronoun"}, {word: "wrote", type: "Verb"}, {word: "a", type: "Determiner"}, {word: "letter", type: "Noun"}, {word: "with", type: "Preposition"}, {word: "a", type: "Determiner"}, {word: "pencil", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Determiner_Noun_Verb_Determiner_Noun_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Prepositional Phrase - Punctuation', 
                words: [{word: "The", type: "Determiner"}, {word: "dog", type: "Noun"}, {word: "chased", type: "Verb"}, {word: "the", type: "Determiner"}, {word: "cat", type: "Noun"}, {word: "up", type: "Preposition"}, {word: "a", type: "Determiner"}, {word: "tree", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Pronoun_Verb_Determiner_Adjective_Noun_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Prepositional Phrase - Punctuation', 
                words: [{word: "We", type: "Pronoun"}, {word: "had", type: "Verb"}, {word: "a", type: "Determiner"}, {word: "great", type: "Adjective"}, {word: "time", type: "Noun"}, {word: "at", type: "Preposition"}, {word: "the", type: "Determiner"}, {word: "party", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
            { 
                rule: "Determiner_Noun_Verb_Determiner_Noun_Preposition_Determiner_Noun_Punctuation",
                displayRule: 'Subject - Verb - Object - Prepositional Phrase - Punctuation', 
                words: [{word: "The", type: "Determiner"}, {word: "cat", type: "Noun"}, {word: "jumped", type: "Verb"}, {word: "over", type: "Preposition"}, {word: "the", type: "Determiner"}, {word: "fence", type: "Noun"}, {word: ".", type: "Punctuation"}]
            },
        ]
    };

    const quizData = {
        beginner: [
            { question: "Which word is the NOUN in the sentence: 'The cat sat on the mat.'?", options: ["The", "cat", "sat", "on"], answer: "cat" },
            { question: "Identify the VERB: 'Birds fly high in the sky.'", options: ["Birds", "fly", "high", "sky"], answer: "fly" },
            { question: "What part of speech is 'happy' in 'She is a happy girl.'?", options: ["Noun", "Verb", "Adjective", "Adverb"], answer: "Adjective" },
            { question: "Find the PRONOUN: 'He threw the ball to them.'", options: ["threw", "ball", "to", "He"], answer: "He" },
            { question: "Which word is a DETERMINER in 'An apple a day keeps the doctor away.'?", options: ["apple", "day", "An", "away"], answer: "An" },
            { question: "What is the PUNCTUATION in the sentence: 'Hello!'?", options: [".", ",", "!", "?"], answer: "!" },
            { question: "Identify the NOUN: 'My dog has a fluffy tail.'", options: ["My", "has", "fluffy", "dog"], answer: "dog" },
            { question: "Which is the VERB in 'They quickly ran home.'?", options: ["They", "quickly", "ran", "home"], answer: "ran" },
            { question: "Find the ADJECTIVE: 'It was a beautiful day.'", options: ["It", "was", "beautiful", "day"], answer: "beautiful" },
            { question: "What part of speech is 'I' in 'I love this game.'?", options: ["Noun", "Pronoun", "Verb", "Adjective"], answer: "Pronoun" }
        ],
        advanced: [
            { question: "What is the ADVERB in 'She sings beautifully.'?", options: ["She", "sings", "beautifully", "."], answer: "beautifully" },
            { question: "Identify the PREPOSITION: 'The book is on the table.'", options: ["book", "is", "on", "table"], answer: "on" },
            { question: "Which word is the CONJUNCTION in 'I am tired, but I will finish.'?", options: ["am", "tired", "but", "finish"], answer: "but" },
            { question: "What role does 'running' play in 'Running is good exercise.'?", options: ["Verb", "Adjective", "Noun (Gerund)", "Adverb"], answer: "Noun (Gerund)" },
            { question: "Find the PREPOSITIONAL PHRASE: 'The man with the yellow hat smiled.'", options: ["The man", "with the yellow hat", "yellow hat", "smiled"], answer: "with the yellow hat" },
            { question: "Identify the ADVERB: 'He works very hard.'", options: ["He", "works", "very", "hard"], answer: "very" },
            { question: "What part of speech is 'although' in 'Although it was raining, we went out.'?", options: ["Adverb", "Preposition", "Conjunction", "Pronoun"], answer: "Conjunction" },
            { question: "Find the POSSESSIVE pronoun: 'That blue car is hers.'", options: ["That", "blue", "is", "hers"], answer: "hers" },
            { question: "What is the object of the preposition in 'She walked through the door.'?", options: ["She", "walked", "through", "door"], answer: "door" },
            { question: "Identify the CONJUNCTION: 'He is not only smart but also funny.'", options: ["not", "only", "but", "also"], answer: "but" }
        ],
        professional: [
            { question: "What type of clause is 'who is my best friend' in 'John, who is my best friend, is a doctor.'?", options: ["Adverbial Clause", "Noun Clause", "Relative Clause", "Main Clause"], answer: "Relative Clause" },
            { question: "Identify the part of speech for 'however' in 'The task was difficult; however, we succeeded.'", options: ["Subordinating Conjunction", "Coordinating Conjunction", "Conjunctive Adverb", "Adjective"], answer: "Conjunctive Adverb" },
            { question: "What is the grammatical function of 'to win' in 'Her goal is to win.'?", options: ["Adjective", "Adverb", "Infinitive as Noun", "Prepositional Phrase"], answer: "Infinitive as Noun" },
            { question: "Which term describes the phrase 'Having finished her work' in 'Having finished her work, she went home.'?", options: ["Gerund Phrase", "Infinitive Phrase", "Participial Phrase", "Prepositional Phrase"], answer: "Participial Phrase" },
            { question: "In 'I made him the captain,' what is 'the captain'?", options: ["Direct Object", "Indirect Object", "Predicate Nominative", "Object Complement"], answer: "Object Complement" },
            { question: "What mood is the verb in 'If I were you, I would not go.'?", options: ["Indicative", "Imperative", "Subjunctive", "Conditional"], answer: "Subjunctive" },
            { question: "Identify the gerund in the sentence: 'I enjoy swimming.'", options: ["I", "enjoy", "swimming", "."], answer: "swimming" },
            { question: "What is the function of the noun clause in 'I know that you are right.'?", options: ["Subject", "Direct Object", "Appositive", "Predicate Nominative"], answer: "Direct Object" },
            { question: "Which of the following is an example of an appositive phrase: 'My brother, a talented artist, won the award.'?", options: ["My brother", "a talented artist", "won the award", "the award"], answer: "a talented artist" },
            { question: "What is the verb tense in 'She will have finished by noon.'?", options: ["Future Simple", "Future Continuous", "Future Perfect", "Future Perfect Continuous"], answer: "Future Perfect" }
        ]
    };

    // --- TILE INTERACTION LOGIC ---
    let draggedTile = null;
    let placeholder = null;

    function createPlaceholder() {
        const p = document.createElement('div');
        p.className = 'placeholder';
        // Match style with word-tile for sizing
        p.style.width = draggedTile.offsetWidth + 'px';
        p.style.height = draggedTile.offsetHeight + 'px';
        p.style.margin = getComputedStyle(draggedTile).margin;
        return p;
    }

    /**
     * Determines which element the dragged tile should be inserted before.
     * This version is more robust for multi-line flex containers.
     * @param {HTMLElement} container The container being dragged over.
     * @param {number} x The clientX of the mouse event.
     * @param {number} y The clientY of the mouse event.
     * @returns {HTMLElement|null} The element to insert before, or null to append.
     */
    function getDragAfterElement(container, x, y) {
        const draggableElements = [...container.querySelectorAll('.word-tile:not(.dragging)')];
        
        let closestElement = null;
        let minDistance = Number.POSITIVE_INFINITY;

        // Find the element whose center is geometrically closest to the cursor
        draggableElements.forEach(child => {
            const box = child.getBoundingClientRect();
            const centerX = box.left + box.width / 2;
            const centerY = box.top + box.height / 2;
            const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));

            if (distance < minDistance) {
                minDistance = distance;
                closestElement = child;
            }
        });

        if (!closestElement) {
            return null;
        }

        const closestBox = closestElement.getBoundingClientRect();
        // Decide whether to insert before or after the closest element based on horizontal position.
        if (x > closestBox.left + closestBox.width / 2) {
            // Cursor is to the right of the center, so insert *after* it (by returning its next sibling).
            return closestElement.nextElementSibling;
        } else {
            // Cursor is to the left of the center, so insert *before* it.
            return closestElement;
        }
    }

    function setupTileInteractions() {
        // CLICK to move tiles between pool and tray
        elements.gameContainer.addEventListener('click', (e) => {
            if (!e.target.classList.contains('word-tile')) return;

            const tile = e.target;
            const sourceContainer = tile.parentElement;

            if (sourceContainer.id === 'word-pool') {
                elements.sentenceTray.appendChild(tile);
                tile.draggable = true;
            } else if (sourceContainer.id === 'sentence-tray') {
                elements.wordPool.appendChild(tile);
                tile.draggable = false;
            }
        });

        // DRAG AND DROP for reordering and returning tiles
        document.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('word-tile') && e.target.draggable) {
                draggedTile = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
                placeholder = createPlaceholder();
            }
        });

        document.addEventListener('dragend', () => {
            if (draggedTile) {
                draggedTile.classList.remove('dragging');
                draggedTile = null;
                if (placeholder && placeholder.parentElement) {
                    placeholder.remove();
                }
                placeholder = null;
            }
        });

        const droppables = [elements.sentenceTray, elements.wordPool];
        droppables.forEach(zone => {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
                
                if (draggedTile && zone.id === 'sentence-tray') {
                    const afterElement = getDragAfterElement(zone, e.clientX, e.clientY);
                    if (afterElement) {
                        zone.insertBefore(placeholder, afterElement);
                    } else {
                        zone.appendChild(placeholder);
                    }
                }
            });
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                
                if (placeholder && placeholder.parentElement) {
                    placeholder.remove();
                }

                if (draggedTile) {
                    if (zone.id === 'sentence-tray') {
                        const afterElement = getDragAfterElement(zone, e.clientX, e.clientY);
                        zone.insertBefore(draggedTile, afterElement); // insertBefore(el, null) appends
                    } 
                    else if (zone.id === 'word-pool') {
                        zone.appendChild(draggedTile);
                        draggedTile.draggable = false;
                    }
                }
            });
        });
    }

    // --- GAME LOGIC ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function createWordTile(wordData) {
        const tile = document.createElement('div');
        tile.classList.add('word-tile');
        tile.textContent = wordData.word;
        tile.dataset.type = wordData.type;
        tile.draggable = false; // Tiles start as not draggable in the pool
        return tile;
    }

    function loadQuestion(index) {
        clearFeedback();
        elements.checkBtn.disabled = false;
        
        const levelData = levels[state.proficiency];
        state.totalQuestions = levelData.length;
        const questionData = levelData[index];

        state.currentWords = [...questionData.words];

        elements.targetGrammar.textContent = questionData.displayRule;
        elements.levelIndicator.textContent = `Proficiency: ${state.proficiency.charAt(0).toUpperCase() + state.proficiency.slice(1)}`;
        elements.questionIndicator.textContent = `Question: ${index + 1}/${state.totalQuestions}`;
        elements.progressBar.style.width = `${((index + 1) / state.totalQuestions) * 100}%`;

        elements.sentenceTray.innerHTML = '';
        elements.wordPool.innerHTML = '';

        const shuffledWords = [...questionData.words];
        shuffleArray(shuffledWords);
        shuffledWords.forEach(word => {
            elements.wordPool.appendChild(createWordTile(word));
        });

        resetTimer();
        startTimer();
    }

    function checkAnswer() {
        clearInterval(state.timerInterval);
        const sentenceTiles = elements.sentenceTray.querySelectorAll('.word-tile');
        if (sentenceTiles.length === 0) {
            showFeedback("Please build a sentence first.", 'incorrect');
            startTimer(); // Resume timer if no answer submitted
            return;
        }

        const sentenceTypes = Array.from(sentenceTiles).map(tile => tile.dataset.type);
        const sentenceString = sentenceTypes.join(' ');
        const currentRule = levels[state.proficiency][state.currentQuestionIndex].rule;

        const match = grammar.match(sentenceString, currentRule);

        if (match.succeeded()) {
            const points = calculateScore();
            state.score += points;
            showFeedback(`Correct! +${points} points`, 'correct');
            if (state.gameMode === 'multi' && state.socket) {
                state.playerData.score = state.score;
                state.socket.emit('updateScore', state.playerData);
            }
            elements.checkBtn.disabled = true;
            setTimeout(nextQuestion, 1500);
        } else {
            showFeedback("That's not quite right. Try again!", 'incorrect');
        }
    }
    
    function calculateScore() {
        // Base score + time bonus
        const baseScore = 100;
        const timeBonus = Math.max(0, state.timer * 2); 
        return baseScore + timeBonus;
    }

    function nextQuestion() {
        state.currentQuestionIndex++;
        if (state.currentQuestionIndex < state.totalQuestions) {
            loadQuestion(state.currentQuestionIndex);
        } else {
            endGame('Level Complete!', "You've answered all questions for this level.");
        }
    }

    function resetCurrentQuestion() {
        clearInterval(state.timerInterval);
        loadQuestion(state.currentQuestionIndex);
    }
    
    function startTimer() {
        clearInterval(state.timerInterval); // Ensure no multiple timers running
        state.timerInterval = setInterval(() => {
            state.timer--;
            elements.timerDisplay.textContent = `Time: ${state.timer}`;
            if (state.timer <= 0) {
                clearInterval(state.timerInterval);
                showFeedback("Time's up! Moving to the next question.", 'incorrect');
                setTimeout(nextQuestion, 2000);
            }
        }, 1000);
    }

    function resetTimer() {
        state.timer = 50;
        elements.timerDisplay.textContent = `Time: ${state.timer}`;
    }

    function showFeedback(message, type) {
        elements.feedbackArea.textContent = message;
        elements.feedbackArea.className = `feedback-${type}`;
    }

    function clearFeedback() {
        elements.feedbackArea.textContent = '';
        elements.feedbackArea.className = '';
    }

    // --- UI & MODAL MANAGEMENT ---
    function showModal(modal) {
        modal.style.display = 'flex';
    }

    function hideModal(modal) {
        modal.style.display = 'none';
    }

    function setupUI() {
        elements.checkBtn.addEventListener('click', checkAnswer);
        elements.resetBtn.addEventListener('click', resetCurrentQuestion);

        // Mode selection
        elements.singlePlayerBtn.addEventListener('click', () => {
            state.gameMode = 'single';
            hideModal(elements.modeModal);
            showModal(elements.playerSetupModal);
            checkForSavedGame();
        });
        elements.multiplayerBtn.addEventListener('click', () => {
            state.gameMode = 'multi';
            hideModal(elements.modeModal);
            showModal(elements.multiplayerModal);
            initializeSocket();
        });
        elements.quizBtn.addEventListener('click', () => {
            state.gameMode = 'quiz';
            hideModal(elements.modeModal);
            showModal(elements.quizSetupModal);
        });

        // Single Player Setup
        elements.proficiencyBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                state.proficiency = btn.dataset.level;
                startGame();
            });
        });
        elements.backFromSetupBtn.addEventListener('click', () => {
            hideModal(elements.playerSetupModal);
            showModal(elements.modeModal);
        });

        // Multiplayer Setup
        elements.multiplayerCreateTab.addEventListener('click', () => {
             elements.multiplayerCreateTab.classList.add('active');
             elements.multiplayerJoinTab.classList.remove('active');
             elements.groupCodeInput.style.display = 'none';
             elements.createGroupBtn.style.display = 'block';
             elements.joinGroupBtn.style.display = 'none';
        });
        elements.multiplayerJoinTab.addEventListener('click', () => {
             elements.multiplayerJoinTab.classList.add('active');
             elements.multiplayerCreateTab.classList.remove('active');
             elements.groupCodeInput.style.display = 'block';
             elements.createGroupBtn.style.display = 'none';
             elements.joinGroupBtn.style.display = 'block';
        });
        elements.createGroupBtn.addEventListener('click', createGroup);
        elements.joinGroupBtn.addEventListener('click', joinGroup);
        elements.backFromMultiplayerBtn.addEventListener('click', () => {
            hideModal(elements.multiplayerModal);
            showModal(elements.modeModal);
            if (state.socket) {
                state.socket.disconnect();
                state.socket = null;
            }
        });
        elements.nicknameInput.addEventListener('input', () => {
            const isNicknameValid = elements.nicknameInput.value.trim().length > 0;
            elements.createGroupBtn.disabled = !isNicknameValid;
            elements.joinGroupBtn.disabled = !isNicknameValid || elements.groupCodeInput.value.length !== 3;
        });
         elements.groupCodeInput.addEventListener('input', () => {
            const isNicknameValid = elements.nicknameInput.value.trim().length > 0;
            elements.joinGroupBtn.disabled = !isNicknameValid || elements.groupCodeInput.value.length !== 3;
        });

        // Multiplayer Proficiency (Host only)
        elements.multiplayerProficiencyBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                state.proficiency = btn.dataset.level;
                if (state.socket) {
                    state.socket.emit('setProficiency', { groupCode: state.groupCode, proficiency: state.proficiency });
                }
                hideModal(elements.multiplayerProficiencyModal);
                showModal(elements.waitingRoomModal);
                elements.startGameBtn.style.display = 'block';
            });
        });
        elements.backFromMultiplayerProficiencyBtn.addEventListener('click', () => {
            // This should disconnect and go back to the multiplayer setup
            hideModal(elements.multiplayerProficiencyModal);
            showModal(elements.multiplayerModal);
             if (state.socket) {
                state.socket.emit('disconnect'); // This won't work, need server-side logic to handle group teardown. For now, just disconnect.
                state.socket.disconnect();
            }
        });

        // Waiting Room
        elements.startGameBtn.addEventListener('click', () => {
             if (state.socket && state.players.length > 0 && state.players[0].id === state.playerData.id) {
                state.socket.emit('startGameRequest', { groupCode: state.groupCode, proficiency: state.proficiency });
            }
        });
        elements.backFromWaitingBtn.addEventListener('click', () => {
            // Disconnect and return to main menu
            location.reload(); 
        });
        
        // Game Over
        elements.playAgainBtn.addEventListener('click', () => {
            location.reload(); // Simple way to restart
        });

        // Save/Resume Logic
        elements.resumeGameBtn.addEventListener('click', resumeGame);

        // Quiz Setup
        elements.quizProficiencyBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                state.quizProficiency = btn.dataset.level;
                startQuiz();
            });
        });
        elements.backFromQuizSetupBtn.addEventListener('click', () => {
            hideModal(elements.quizSetupModal);
            showModal(elements.modeModal);
        });
    }

    function startGame() {
        hideModal(elements.playerSetupModal);
        elements.gameContainer.style.display = 'block';
        elements.gameView.style.display = 'block';
        elements.quizView.style.display = 'none';

        state.currentQuestionIndex = 0;
        state.score = 0;
        
        loadQuestion(state.currentQuestionIndex);
        
        if (state.gameMode === 'single') {
            window.addEventListener('beforeunload', saveGameState);
        }
    }
    
    function endGame(title, message) {
        clearInterval(state.timerInterval);
        elements.gameOverTitle.textContent = title;
        elements.gameOverMessage.textContent = message;
        elements.finalScore.textContent = state.gameMode === 'quiz' ? state.quizScore : state.score;
        showModal(elements.gameOverModal);
        
        if (state.gameMode === 'single') {
            localStorage.removeItem('syntaxGameState');
            window.removeEventListener('beforeunload', saveGameState);
        }
    }
    
    // --- LOCAL STORAGE (SINGLE PLAYER) ---
    function saveGameState() {
        const gameState = {
            proficiency: state.proficiency,
            currentQuestionIndex: state.currentQuestionIndex,
            score: state.score,
            timer: state.timer
        };
        localStorage.setItem('syntaxGameState', JSON.stringify(gameState));
    }

    function checkForSavedGame() {
        if (localStorage.getItem('syntaxGameState')) {
            elements.resumeGameContainer.style.display = 'block';
        } else {
            elements.resumeGameContainer.style.display = 'none';
        }
    }

    function resumeGame() {
        const savedState = JSON.parse(localStorage.getItem('syntaxGameState'));
        if (savedState) {
            state.proficiency = savedState.proficiency;
            state.currentQuestionIndex = savedState.currentQuestionIndex;
            state.score = savedState.score;
            state.timer = savedState.timer;
            startGame();
            // Override timer from saved state
            resetTimer();
            state.timer = savedState.timer > 0 ? savedState.timer : 50;
            startTimer();
        }
    }

    // --- MULTIPLAYER LOGIC ---
    function initializeSocket() {
        // Use a placeholder URL for local development, which will be replaced by the hosting environment.
        const serverUrl = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" 
                        ? 'http://localhost:3000' 
                        : 'https://syntax-card-game-server.onrender.com';
        
        state.socket = io(serverUrl);
        elements.multiplayerFeedback.textContent = 'Connecting to server...';

        state.socket.on('connect', () => {
            console.log('Connected to server with ID:', state.socket.id);
            state.playerData.id = state.socket.id;
            elements.multiplayerFeedback.textContent = '';
            elements.createGroupBtn.disabled = elements.nicknameInput.value.trim().length === 0;
        });
        
        state.socket.on('connect_error', (err) => {
            console.error('Connection Error:', err);
            elements.multiplayerFeedback.textContent = 'Failed to connect to server.';
            elements.createGroupBtn.disabled = true;
            elements.joinGroupBtn.disabled = true;
        });

        state.socket.on('groupCreated', ({ groupCode, players }) => {
            state.groupCode = groupCode;
            state.players = players;
            state.playerData.groupCode = groupCode;
            hideModal(elements.multiplayerModal);
            
            // Host chooses proficiency
            showModal(elements.multiplayerProficiencyModal);
            
            updateWaitingRoom(players);
            elements.groupCodeDisplay.textContent = groupCode;
        });
        
        state.socket.on('joinSuccess', ({ groupCode }) => {
            state.groupCode = groupCode;
            state.playerData.groupCode = groupCode;
            hideModal(elements.multiplayerModal);
            showModal(elements.waitingRoomModal);
            elements.groupCodeDisplay.textContent = groupCode;
        });
        
        state.socket.on('joinError', (message) => {
            elements.multiplayerFeedback.textContent = message;
        });
        
        state.socket.on('updatePlayers', (players) => {
            updateWaitingRoom(players);
            if (state.gameMode === 'multi' && elements.gameContainer.style.display === 'block') {
                updateScoreboard(players);
            }
        });
        
        state.socket.on('gameStarted', ({ proficiency }) => {
            state.proficiency = proficiency;
            hideModal(elements.waitingRoomModal);
            hideModal(elements.multiplayerProficiencyModal);
            startGame();
            elements.multiplayerScoreboard.style.display = 'block';
            updateScoreboard(state.players);
        });
    }
    
    function createGroup() {
        const nickname = elements.nicknameInput.value.trim();
        if (nickname && state.socket) {
            state.playerData.nickname = nickname;
            state.socket.emit('createGroup', state.playerData);
        }
    }

    function joinGroup() {
        const nickname = elements.nicknameInput.value.trim();
        const groupCode = elements.groupCodeInput.value.trim();
        if (nickname && groupCode && state.socket) {
            state.playerData.nickname = nickname;
            state.socket.emit('joinGroup', { playerData: state.playerData, groupCode });
        }
    }
    
    function updateWaitingRoom(players) {
        state.players = players;
        elements.waitingPlayerList.innerHTML = '';
        players.forEach(p => {
            const li = document.createElement('li');
            li.textContent = p.nickname + (p.id === state.playerData.id ? ' (You)' : '');
            elements.waitingPlayerList.appendChild(li);
        });
        
        // Host control logic
        const isHost = state.players.length > 0 && state.players[0].id === state.playerData.id;
        if (isHost && elements.waitingRoomModal.style.display === 'flex' && elements.multiplayerProficiencyModal.style.display === 'none') {
            elements.startGameBtn.style.display = 'block';
        }
    }
    
    function updateScoreboard(players) {
        // Sort players by score descending
        const sortedPlayers = [...players].sort((a, b) => b.score - a.score);

        elements.playerScoresList.innerHTML = '';
        sortedPlayers.forEach(p => {
            const li = document.createElement('li');
            const nameSpan = document.createElement('span');
            nameSpan.className = 'player-name';
            nameSpan.textContent = p.nickname + (p.id === state.playerData.id ? ' (You)' : '');
            
            const scoreSpan = document.createElement('span');
            scoreSpan.className = 'player-score';
            scoreSpan.textContent = p.score;
            
            li.appendChild(nameSpan);
            li.appendChild(scoreSpan);
            elements.playerScoresList.appendChild(li);
        });
    }

    // --- QUIZ LOGIC ---
    function startQuiz() {
        hideModal(elements.quizSetupModal);
        elements.gameContainer.style.display = 'block';
        elements.gameView.style.display = 'none';
        elements.quizView.style.display = 'block';

        state.quizQuestions = quizData[state.quizProficiency];
        state.totalQuestions = state.quizQuestions.length;
        state.currentQuizQuestionIndex = 0;
        state.quizScore = 0;

        loadQuizQuestion(state.currentQuizQuestionIndex);
    }

    function loadQuizQuestion(index) {
        elements.quizLevelIndicator.textContent = `Difficulty: ${state.quizProficiency.charAt(0).toUpperCase() + state.quizProficiency.slice(1)}`;
        elements.quizQuestionIndicator.textContent = `Question: ${index + 1}/${state.totalQuestions}`;
        elements.quizProgressBar.style.width = `${((index + 1) / state.totalQuestions) * 100}%`;
        elements.quizFeedbackArea.textContent = '';
        elements.nextQuestionBtn.style.display = 'none';
        
        const question = state.quizQuestions[index];
        elements.quizQuestionText.textContent = question.question;
        elements.quizOptionsArea.innerHTML = '';

        const shuffledOptions = [...question.options];
        shuffleArray(shuffledOptions);

        shuffledOptions.forEach(optionText => {
            const button = document.createElement('button');
            button.className = 'quiz-option-btn';
            button.textContent = optionText;
            button.addEventListener('click', () => checkQuizAnswer(button, optionText, question.answer));
            elements.quizOptionsArea.appendChild(button);
        });
    }

    function checkQuizAnswer(button, selectedOption, correctAnswer) {
        const allOptionBtns = elements.quizOptionsArea.querySelectorAll('.quiz-option-btn');
        allOptionBtns.forEach(btn => btn.disabled = true);

        if (selectedOption === correctAnswer) {
            button.classList.add('correct');
            elements.quizFeedbackArea.textContent = 'Correct!';
            elements.quizFeedbackArea.style.color = 'var(--success)';
            state.quizScore += 100;
        } else {
            button.classList.add('incorrect');
            elements.quizFeedbackArea.textContent = `Incorrect. The correct answer is "${correctAnswer}".`;
            elements.quizFeedbackArea.style.color = 'var(--error)';
            // Highlight the correct answer
            allOptionBtns.forEach(btn => {
                if (btn.textContent === correctAnswer) {
                    btn.classList.add('correct');
                }
            });
        }
        elements.nextQuestionBtn.style.display = 'block';
    }

    function nextQuizQuestion() {
        state.currentQuizQuestionIndex++;
        if (state.currentQuizQuestionIndex < state.totalQuestions) {
            loadQuizQuestion(state.currentQuizQuestionIndex);
        } else {
            endGame("Quiz Complete!", "You've finished all the quiz questions.");
        }
    }
    
    // --- APP INITIALIZATION ---
    function initialize() {
        setupUI();
        setupTileInteractions();
        elements.nextQuestionBtn.addEventListener('click', nextQuizQuestion);
        showModal(elements.modeModal);
    }

    initialize();
</script>
</body>
</html>
